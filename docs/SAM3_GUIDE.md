 # SAM 3 Integration Guide

This guide explains how to use **SAM 3 (Segment Anything Model 3)** with the Video Autolabeling Pipeline.

SAM 3 allows you to:
1.  **Refine Bounding Boxes**: Convert MLLM-generated boxes into precise segmentation masks.
2.  **Text-to-Mask**: Generate masks directly from open-vocabulary text prompts.
3.  **Video Tracking**: Track objects consistently across video frames.

## ðŸ› ï¸ Installation

SAM 3 is a large local model and requires a GPU (NVIDIA or Mac Metal) and specific dependencies.

### 1. Install PyTorch
Ensure you have PyTorch installed. Visit [pytorch.org](https://pytorch.org/) for instructions specific to your system.

```bash
# Example for CUDA 11.8
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118
```

### 2. Install SAM 3
Install the SAM 3 package directly from GitHub.

```bash
pip install git+https://github.com/facebookresearch/sam3.git
```

### 3. Download Checkpoints
You will need to download the SAM 3 model checkpoints.
*(Check the [SAM 3 repository](https://github.com/facebookresearch/sam3) for the latest checkpoint URLs)*

```bash
mkdir -p checkpoints
# Example (replace with actual URL)
wget -P checkpoints/ https://dl.fbaipublicfiles.com/segment_anything_3/sam3_h_4b8939.pth
```

---

## ðŸš€ Usage

We provide a dedicated script `scripts/sam3_auto_labeling.py` for SAM 3 operations.

### Mode 1: Box Refinement (Box -> Mask)
Use this mode to refine bounding boxes generated by `image_auto_labeling.py`.

```bash
# 1. Generate boxes first
python scripts/image_auto_labeling.py data/test_image.jpg --provider qwen --output boxes.json

# 2. Refine to masks using SAM 3
python scripts/sam3_auto_labeling.py data/test_image.jpg \
  --mode box_to_mask \
  --box_input boxes.json \
  --checkpoint checkpoints/sam3_h_4b8939.pth \
  --output masks.json
```

### Mode 2: Text to Mask (Text -> Mask)
Use SAM 3's open-vocabulary capability to find objects directly.

```bash
python scripts/sam3_auto_labeling.py data/test_image.jpg \
  --mode text_to_mask \
  --text_prompt "car . person . traffic light" \
  --checkpoint checkpoints/sam3_h_4b8939.pth \
  --output masks.json
```

### Mode 3: Video Tracking
Track objects across a video.

```bash
python scripts/sam3_auto_labeling.py data/test_video.mp4 \
  --mode video \
  --text_prompt "motorcycle" \
  --checkpoint checkpoints/sam3_h_4b8939.pth \
  --output video_masks.json
```

---

## ðŸ“¤ Label Studio Import

The output JSON files are formatted for Label Studio.
1.  Create a project in Label Studio.
2.  Go to **Settings > Labeling Interface** and ensure you have a `<BrushLabels>` or `<PolygonLabels>` tag configured.
3.  Import the generated JSON file.
